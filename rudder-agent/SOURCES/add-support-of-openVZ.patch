diff -Naur ../source/cfengine-3.4.4/src/cf3.defs.h ./src/cf3.defs.h
--- ../source/cfengine-3.4.4/src/cf3.defs.h	2013-03-15 13:49:36.000000000 +0100
+++ ./src/cf3.defs.h	2014-02-25 09:10:29.354905001 +0100
@@ -323,6 +323,7 @@
 enum classes
 {
     hard_class_unknown,
+    virt_host_vz_vzps,
     hp,
     aix,
     linuxx,
diff -Naur ../source/cfengine-3.4.4/src/cf3.extern.h ./src/cf3.extern.h
--- ../source/cfengine-3.4.4/src/cf3.extern.h	2013-03-15 13:49:36.000000000 +0100
+++ ./src/cf3.extern.h	2014-02-25 09:35:59.618905001 +0100
@@ -75,6 +75,8 @@
 
 extern char VDOMAIN[CF_MAXVARSIZE];
 extern enum classes VSYSTEMHARDCLASS;
+extern enum classes VPSHARDCLASS; /* used to define which ps command to use*/
+
 extern char VFQNAME[];
 extern char VUQNAME[];
 
diff -Naur ../source/cfengine-3.4.4/src/cf3globals.c ./src/cf3globals.c
--- ../source/cfengine-3.4.4/src/cf3globals.c	2013-03-15 13:49:36.000000000 +0100
+++ ./src/cf3globals.c	2014-02-25 09:38:01.418905001 +0100
@@ -251,3 +251,4 @@
 
 Item *VSETUIDLIST = NULL;
 enum classes VSYSTEMHARDCLASS;
+enum classes VPSHARDCLASS; /* used to define which ps command to use*/
diff -Naur ../source/cfengine-3.4.4/src/classes.c ./src/classes.c
--- ../source/cfengine-3.4.4/src/classes.c	2013-03-15 13:49:36.000000000 +0100
+++ ./src/classes.c	2014-02-25 09:10:29.354905001 +0100
@@ -27,6 +27,7 @@
 const char *CLASSTEXT[HARD_CLASSES_MAX] =
 {
     "<unknown>",
+    "virt_host_vz_vzps",
     "hpux",
     "aix",
     "linux",
@@ -48,6 +49,7 @@
 const char *VPSCOMM[HARD_CLASSES_MAX] =
 {
     "",
+    "/bin/vzps -E 0",           /* vz with vzps */
     "/bin/ps",                  /* hpux */
     "/bin/ps",                  /* aix */
     "/bin/ps",                  /* linux */
@@ -72,6 +74,7 @@
 const char *VPSOPTS[HARD_CLASSES_MAX] =
 {
     "",
+    "-eo user,pid,ppid,pgid,pcpu,pmem,vsz,pri,rss,nlwp,stime,time,args", /* vz with vzps */
     "-ef",                      /* hpux */
     "-N -eo user,pid,ppid,pgid,pcpu,pmem,vsz,ni,stat,st=STIME,time,args",  /* aix */
     "-eo user,pid,ppid,pgid,pcpu,pmem,vsz,pri,rss,nlwp,stime,time,args",        /* linux */
@@ -93,6 +96,7 @@
 const char *VFSTAB[HARD_CLASSES_MAX] =
 {
     "-",
+    "/etc/fstab",               /* vz with vzps */
     "/etc/fstab",               /* hpux */
     "/etc/filesystems",         /* aix */
     "/etc/fstab",               /* linux */
diff -Naur ../source/cfengine-3.4.4/src/crypto.c ./src/crypto.c
--- ../source/cfengine-3.4.4/src/crypto.c	2013-03-15 13:49:36.000000000 +0100
+++ ./src/crypto.c	2014-02-25 10:15:38.262905001 +0100
@@ -329,7 +329,7 @@
 
     EVP_DigestUpdate(&context, buffer, CF_BUFSIZE);
 
-    snprintf(pscomm, CF_BUFSIZE, "%s %s", VPSCOMM[VSYSTEMHARDCLASS], VPSOPTS[VSYSTEMHARDCLASS]);
+    snprintf(pscomm, CF_BUFSIZE, "%s %s", VPSCOMM[VPSHARDCLASS], VPSOPTS[VPSHARDCLASS]);
 
     if ((pp = cf_popen(pscomm, "r")) != NULL)
     {
diff -Naur ../source/cfengine-3.4.4/src/mon_network.c ./src/mon_network.c
--- ../source/cfengine-3.4.4/src/mon_network.c	2013-03-15 13:49:36.000000000 +0100
+++ ./src/mon_network.c	2014-02-25 09:10:29.354905001 +0100
@@ -37,6 +37,7 @@
 static const char *VNETSTAT[HARD_CLASSES_MAX] =
 {
     "-",
+    "/bin/netstat -rn",         /* virt_host_vz_vzps */
     "/usr/bin/netstat -rn",     /* hpux */
     "/usr/bin/netstat -rn",     /* aix */
     "/bin/netstat -rn",         /* linux */
diff -Naur ../source/cfengine-3.4.4/src/mon_processes.c ./src/mon_processes.c
--- ../source/cfengine-3.4.4/src/mon_processes.c	2013-03-15 13:49:36.000000000 +0100
+++ ./src/mon_processes.c	2014-02-25 10:13:50.050905001 +0100
@@ -72,7 +72,7 @@
     char user[CF_MAXVARSIZE];
     char vbuff[CF_BUFSIZE];
 
-    snprintf(pscomm, CF_BUFSIZE, "%s %s", VPSCOMM[VSYSTEMHARDCLASS], VPSOPTS[VSYSTEMHARDCLASS]);
+    snprintf(pscomm, CF_BUFSIZE, "%s %s", VPSCOMM[VPSHARDCLASS], VPSOPTS[VPSHARDCLASS]);
 
     if ((pp = cf_popen(pscomm, "r")) == NULL)
     {
diff -Naur ../source/cfengine-3.4.4/src/nfs.c ./src/nfs.c
--- ../source/cfengine-3.4.4/src/nfs.c	2013-03-15 13:49:36.000000000 +0100
+++ ./src/nfs.c	2014-02-25 09:10:29.358905001 +0100
@@ -42,6 +42,7 @@
 static const char *VMOUNTCOMM[HARD_CLASSES_MAX] =
 {
     "",
+    "/bin/mount -va",           /* virt_host_vz_vzps */
     "/sbin/mount -ea",          /* hpux */
     "/usr/sbin/mount -t nfs",   /* aix */
     "/bin/mount -va",           /* linux */
@@ -63,6 +64,7 @@
 static const char *VUNMOUNTCOMM[HARD_CLASSES_MAX] =
 {
     "",
+    "/bin/umount",              /* virt_host_vz_vzps */
     "/sbin/umount",             /* hpux */
     "/usr/sbin/umount",         /* aix */
     "/bin/umount",              /* linux */
@@ -84,6 +86,7 @@
 static const char *VMOUNTOPTS[HARD_CLASSES_MAX] =
 {
     "",
+    "defaults",                 /* virt_host_vz_vzps */
     "bg,hard,intr",             /* hpux */
     "bg,hard,intr",             /* aix */
     "defaults",                 /* linux */
diff -Naur ../source/cfengine-3.4.4/src/sysinfo.c ./src/sysinfo.c
--- ../source/cfengine-3.4.4/src/sysinfo.c	2013-03-15 13:49:36.000000000 +0100
+++ ./src/sysinfo.c	2014-02-25 10:04:05.746905002 +0100
@@ -49,6 +49,7 @@
 static int Linux_Mandrake_Version(void);
 static int Linux_Mandriva_Version(void);
 static int Linux_Mandriva_Version_Real(char *filename, char *relstring, char *vendor);
+static int OpenVZ_Detect(void);
 static int VM_Version(void);
 static int Xen_Domain(void);
 
@@ -66,6 +67,7 @@
 static const char *CLASSATTRIBUTES[HARD_CLASSES_MAX][3] =
 {
     {"-", "-", "-"},            /* as appear here are matched. The fields are sysname and machine */
+    {"virt_host_vz_vzps", ".*", ".*"},        /* virt_host_vz_vzps */
     {"hp-ux", ".*", ".*"},      /* hpux */
     {"aix", ".*", ".*"},        /* aix */
     {"linux", ".*", ".*"},      /* linux */
@@ -87,6 +89,7 @@
 static const char *VRESOLVCONF[HARD_CLASSES_MAX] =
 {
     "-",
+    "/etc/resolv.conf",         /* virt_host_vz_vzps */
     "/etc/resolv.conf",         /* hpux */
     "/etc/resolv.conf",         /* aix */
     "/etc/resolv.conf",         /* linux */
@@ -108,6 +111,7 @@
 static const char *VMAILDIR[HARD_CLASSES_MAX] =
 {
     "-",
+    "/var/spool/mail",          /* virt_host_vz_vzps */
     "/var/mail",                /* hpux */
     "/var/spool/mail",          /* aix */
     "/var/spool/mail",          /* linux */
@@ -129,6 +133,7 @@
 static const char *VEXPORTS[HARD_CLASSES_MAX] =
 {
     "-",
+    "/etc/exports",             /* virt_host_vz_vzps */
     "/etc/exports",             /* hpux */
     "/etc/exports",             /* aix */
     "/etc/exports",             /* linux */
@@ -312,6 +317,7 @@
                     found = true;
 
                     VSYSTEMHARDCLASS = (enum classes) i;
+                    VPSHARDCLASS = (enum classes) i; /* this one can be overriden at vz detection */
                     NewScalar("sys", "class", CLASSTEXT[i], cf_str);
                     break;
                 }
@@ -874,6 +880,11 @@
 
 #endif
 
+    if (cfstat("/proc/self/status", &statbuf) != -1)
+    {
+        OpenVZ_Detect();
+    }
+
     GetCPUInfo();
 
 #ifdef CFCYG
@@ -1867,6 +1878,49 @@
 
     return 0;
 }
+/******************************************************************/
+static int OpenVZ_Detect(void)
+{
+#define OPENVZ_HOST_FILENAME "/proc/bc/0"
+#define OPENVZ_GUEST_FILENAME "/proc/vz"
+#define OPENVZ_VZPS_FILE "/bin/vzps"
+    struct stat statbuf;
+    int i;
+
+    /* The file /proc/bc/0 is present on host
+       The file /proc/vz is present on guest
+       If the host has /bin/vzps, we should use it for checking processes
+    */
+
+    if (cfstat(OPENVZ_HOST_FILENAME, &statbuf) != -1)
+    {
+        CfOut(cf_verbose, "", "This appears to be an OpenVZ/Virtuozzo/Parallels Cloud Server host system.\n");
+        HardClass("virt_host_vz");
+        /* if the file /bin/vzps is there, it is safe to use the processes promise type */
+        if (cfstat(OPENVZ_VZPS_FILE, &statbuf) != -1)
+        {
+           HardClass("virt_host_vz_vzps");
+           /* here we must redefine the value of VPSHARDCLASS */
+           for (i = 0; i < HARD_CLASSES_MAX; i++)
+           {
+             if (FullTextMatch(CLASSATTRIBUTES[i][0], "virt_host_vz_vzps"))
+             {
+               VPSHARDCLASS = (enum classes) i;
+               break;
+             }
+           }
+        }
+        else
+        {
+           CfOut(cf_inform, "", "This OpenVZ/Virtuozzo/Parallels Cloud Server host system does not have vzps installed; the processes promise type may not work as expected.\n");
+        }
+    }
+    else if (cfstat(OPENVZ_GUEST_FILENAME, &statbuf) != -1)
+    {
+        CfOut(cf_verbose, "", "This appears to be an OpenVZ/Virtuozzo/Parallels Cloud Server guest system.\n");
+        HardClass("virt_guest_vz");
+    }
+}
 
 /******************************************************************/
 
@@ -1976,6 +2030,7 @@
   : "=a"(*eax), "=r"(*ebx), "=c"(*ecx), "=d"(*edx):"0"(idx), "2"(0));
 }
 
+
 /******************************************************************/
 
 static int Xen_Hv_Check(void)
diff -Naur ../source/cfengine-3.4.4/src/unix.c ./src/unix.c
--- ../source/cfengine-3.4.4/src/unix.c	2013-03-15 13:49:36.000000000 +0100
+++ ./src/unix.c	2014-02-25 10:15:03.406905001 +0100
@@ -441,7 +441,7 @@
 
     if (strcmp(zone, "global") == 0)
     {
-        snprintf(psopts, CF_BUFSIZE, "%s,zone", VPSOPTS[VSYSTEMHARDCLASS]);
+        snprintf(psopts, CF_BUFSIZE, "%s,zone", VPSOPTS[VPSHARDCLASS]);
         return psopts;
     }
 # endif
@@ -455,7 +455,7 @@
 
 # endif
 
-    return VPSOPTS[VSYSTEMHARDCLASS];
+    return VPSOPTS[VPSHARDCLASS];
 }
 
 int LoadProcessTable(Item **procdata)
@@ -473,7 +473,7 @@
 
     const char *psopts = GetProcessOptions();
 
-    snprintf(pscomm, CF_MAXLINKSIZE, "%s %s", VPSCOMM[VSYSTEMHARDCLASS], psopts);
+    snprintf(pscomm, CF_MAXLINKSIZE, "%s %s", VPSCOMM[VPSHARDCLASS], psopts);
 
     CfOut(cf_verbose, "", "Observe process table with %s\n", pscomm);
 
