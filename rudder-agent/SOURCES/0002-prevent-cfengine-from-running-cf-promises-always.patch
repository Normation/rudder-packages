From eb00c827deadac26875bf0a02565a88861345c13 Mon Sep 17 00:00:00 2001
From: Sigurd Teigen <sigurd.teigen@cfengine.com>
Date: Tue, 15 Oct 2013 10:49:29 -0400
Subject: [PATCH] Remove global PROMISETIME

---
 cf-execd/cf-execd.c               |  1 -
 cf-serverd/cf-serverd-functions.c |  1 -
 libpromises/cf3.extern.h          |  1 -
 libpromises/generic_agent.c       | 14 ++++++--------
 4 files changed, 6 insertions(+), 11 deletions(-)

diff --git a/cf-execd/cf-execd.c b/cf-execd/cf-execd.c
index 3cc5d43..9894a6c 100644
--- a/cf-execd/cf-execd.c
+++ b/cf-execd/cf-execd.c
@@ -490,7 +490,6 @@ static Reload CheckNewPromises(EvalContext *ctx, const GenericAgentConfig *confi
         else
         {
             Log(LOG_LEVEL_INFO, "New promises file contains syntax errors -- ignoring");
-            PROMISETIME = time(NULL);
         }
     }
     else
diff --git a/cf-serverd/cf-serverd-functions.c b/cf-serverd/cf-serverd-functions.c
index 24efa1e..1e9a751 100644
--- a/cf-serverd/cf-serverd-functions.c
+++ b/cf-serverd/cf-serverd-functions.c
@@ -602,7 +602,6 @@ void CheckFileChanges(EvalContext *ctx, Policy **policy, GenericAgentConfig *con
         else
         {
             Log(LOG_LEVEL_INFO, "File changes contain errors -- ignoring");
-            PROMISETIME = time(NULL);
         }
     }
     else
diff --git a/libpromises/cf3.extern.h b/libpromises/cf3.extern.h
index 0da6094..0cdaeae 100644
--- a/libpromises/cf3.extern.h
+++ b/libpromises/cf3.extern.h
@@ -92,7 +92,6 @@
 extern int CFA_MAXTHREADS;
 extern AgentType THIS_AGENT_TYPE;
 extern int SHOWREPORTS;
-extern time_t PROMISETIME;
 #define CF_LOCKHORIZON ((time_t)(SECONDS_PER_WEEK * 4))
 extern int LASTSEENEXPIREAFTER;
 extern char *DEFAULT_COPYTYPE;
diff --git a/libpromises/generic_agent.c b/libpromises/generic_agent.c
index a1cb9d9..2b52d11 100644
--- a/libpromises/generic_agent.c
+++ b/libpromises/generic_agent.c
@@ -207,7 +207,7 @@ static bool IsPolicyPrecheckNeeded(EvalContext *ctx, GenericAgentConfig *config,
 {
     bool check_policy = false;
 
-    if (IsFileOutsideDefaultRepository(config->input_file))
+    if (IsFileOutsideDefaultRepository(config->original_input_file))
     {
         check_policy = true;
         Log(LOG_LEVEL_VERBOSE, "Input file is outside default repository, validating it");
@@ -507,8 +507,6 @@ static void ShowContext(EvalContext *ctx)
 
 Policy *GenericAgentLoadPolicy(EvalContext *ctx, GenericAgentConfig *config)
 {
-    PROMISETIME = time(NULL);
-
     Policy *main_policy = Cf3ParseFile(config, config->input_file);
 
     if (main_policy)
@@ -883,7 +881,7 @@ int NewPromiseProposals(EvalContext *ctx, const GenericAgentConfig *config, cons
         return true;
     }
 
-    if (sb.st_mtime > validated_at || sb.st_mtime > PROMISETIME)
+    if (sb.st_mtime > validated_at)
     {
         Log(LOG_LEVEL_VERBOSE, "Promises seem to change");
         return true;
@@ -894,7 +892,7 @@ int NewPromiseProposals(EvalContext *ctx, const GenericAgentConfig *config, cons
     snprintf(filename, CF_MAXVARSIZE, "%s/inputs", CFWORKDIR);
     MapName(filename);
 
-    if (IsNewerFileTree(filename, PROMISETIME))
+    if (IsNewerFileTree(filename, validated_at))
     {
         Log(LOG_LEVEL_VERBOSE, "Quick search detected file changes");
         return true;
@@ -923,7 +921,7 @@ int NewPromiseProposals(EvalContext *ctx, const GenericAgentConfig *config, cons
                     break;
                 }
 
-                if (sb.st_mtime > PROMISETIME)
+                if (sb.st_mtime > validated_at)
                 {
                     result = true;
                 }
@@ -945,7 +943,7 @@ int NewPromiseProposals(EvalContext *ctx, const GenericAgentConfig *config, cons
                         break;
                     }
 
-                    if (sb.st_mtime > PROMISETIME)
+                    if (sb.st_mtime > validated_at)
                     {
                         result = true;
                         break;
@@ -970,7 +968,7 @@ int NewPromiseProposals(EvalContext *ctx, const GenericAgentConfig *config, cons
     snprintf(filename, CF_MAXVARSIZE, "%s/policy_server.dat", CFWORKDIR);
     MapName(filename);
 
-    if ((stat(filename, &sb) != -1) && (sb.st_mtime > PROMISETIME))
+    if ((stat(filename, &sb) != -1) && (sb.st_mtime > validated_at))
     {
         result = true;
     }
-- 
1.8.4

