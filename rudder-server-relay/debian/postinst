#!/bin/sh
# postinst script for rudder-server-root
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    configure)

      SITES_TO_DISABLE="default 000-default default-ssl"
      SITES_TO_ENABLE="rudder-relay-vhost rudder-relay-vhost-ssl"

      MODULES_TO_ENABLE="dav dav_fs version ssl"

      for dissite in ${SITES_TO_DISABLE}
      do
        a2dissite ${dissite} >/dev/null 2>&1 || true
      done

      for ensite in ${SITES_TO_ENABLE}
      do
        a2ensite ${ensite} >/dev/null 2>&1
      done

      for enmod in ${MODULES_TO_ENABLE}
      do
        a2enmod ${enmod} >/dev/null 2>&1
      done

      # Create inventory repositories and add rights to the apache user to
      # access /var/rudder/inventories/incoming
      chmod 751 /var/rudder/inventories

      for inventorydir in /var/rudder/inventories/incoming /var/rudder/inventories/accepted-nodes-updates
      do
        chmod 770 ${inventorydir}
        chown -R root:www-data ${inventorydir}
      done

      # Setup password files for inventory reception WebDAV access
      for passwdfile in /opt/rudder/etc/htpasswd-webdav-initial /opt/rudder/etc/htpasswd-webdav
      do
        htpasswd -bc ${passwdfile} rudder rudder >/dev/null 2>&1
      done

      # Generate the SSL certificates if needed
      if [ ! -f /opt/rudder/etc/ssl/rudder-relay.crt ] || [ ! -f /opt/rudder/etc/ssl/rudder-relay.key ]; then
        echo -n "INFO: No usable SSL certificate detected for Rudder relay HTTP/S support, generating one automatically..."
        openssl req -new -x509 -newkey rsa:2048 -subj "/CN=$(hostname --fqdn)/" -keyout /opt/rudder/etc/ssl/rudder-relay.key -out /opt/rudder/etc/ssl/rudder-relay.crt -days 1460 -nodes -sha256 >/dev/null 2>&1
        chgrp www-data /opt/rudder/etc/ssl/rudder-relay.key && chmod 640 /opt/rudder/etc/ssl/rudder-relay.key
        echo " Done"
      fi

      echo -n "INFO: Restarting Apache HTTPd..."
      service apache2 restart >/dev/null 2>&1
      echo " Done"

      # Only output this notice during initial installation
      if [ -z "${2}" ]; then
        echo ""
        echo "*****************************************************************************************"
        echo "INFO: rudder-server-relay setup complete.                                                "
        echo "INFO:                                                                                    "
        echo "INFO: Now run '/opt/rudder/bin/rudder-node-to-relay $(cat /opt/rudder/etc/uuid.hive)'    "
        echo "INFO: on your root server to complete this node transition to a relay server.            "
        echo "INFO:                                                                                    "
        echo "INFO: Please look at the documentation for details (Section 'Relay servers')             "
        echo "*****************************************************************************************"
      fi

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
